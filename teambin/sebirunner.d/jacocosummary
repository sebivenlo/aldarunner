#!/usr/bin/perl -w

open(CSV, "<$ARGV[0]") or die qq(cannot open csv file\n);
my ($GROUP,$PACKAGE,$CLASS,$INSTRUCTION_MISSED,$INSTRUCTION_COVERED,
    $BRANCH_MISSED,$BRANCH_COVERED,$LINE_MISSED,$LINE_COVERED,$COMPLEXITY_MISSED,$COMPLEXITY_COVERED,$METHOD_MISSED,$METHOD_COVERED);
my ($sum_INSTRUCTION_MISSED,$sum_INSTRUCTION_COVERED,
    $sum_BRANCH_MISSED,$sum_BRANCH_COVERED,$sum_LINE_MISSED,$sum_LINE_COVERED,
    $sum_COMPLEXITY_MISSED,$sum_COMPLEXITY_COVERED,$sum_METHOD_MISSED,$sum_METHOD_COVERED);

$sum_INSTRUCTION_MISSED=0;
$sum_INSTRUCTION_COVERED=0;
$sum_BRANCH_MISSED=0;
$sum_BRANCH_COVERED=0;$sum_LINE_MISSED=0;
$sum_LINE_COVERED=0;
$sum_COMPLEXITY_MISSED=0;
$sum_COMPLEXITY_COVERED=0;
$sum_METHOD_MISSED=0;
$sum_METHOD_COVERED=0;;

while(<CSV>){
  chomp;
  ($GROUP,$PACKAGE,$CLASS,$INSTRUCTION_MISSED,$INSTRUCTION_COVERED,$BRANCH_MISSED,$BRANCH_COVERED,$LINE_MISSED,$LINE_COVERED,$COMPLEXITY_MISSED,$COMPLEXITY_COVERED,$METHOD_MISSED,$METHOD_COVERED)=split/,/;
  if ($INSTRUCTION_MISSED =~ m/\d+/){
    $sum_INSTRUCTION_MISSED +=$INSTRUCTION_MISSED;
    $sum_INSTRUCTION_COVERED +=$INSTRUCTION_COVERED;
    $sum_BRANCH_MISSED +=$BRANCH_MISSED;
    $sum_BRANCH_COVERED +=$BRANCH_COVERED;
    $sum_LINE_MISSED +=$LINE_MISSED;
    $sum_LINE_COVERED +=$LINE_COVERED;
    $sum_COMPLEXITY_MISSED +=$COMPLEXITY_MISSED;
    $sum_COMPLEXITY_COVERED += $COMPLEXITY_COVERED;
    $sum_METHOD_MISSED += $METHOD_MISSED;
    $sum_METHOD_COVERED += $METHOD_COVERED;
  }
}
close(CSV);

open(CSV, ">>$ARGV[0]") or die qq(cannot open csv file for append\n);


print CSV qq(summary,summary,summary,$sum_INSTRUCTION_MISSED,$sum_INSTRUCTION_COVERED,$sum_BRANCH_MISSED,$sum_BRANCH_COVERED,$sum_LINE_MISSED,$sum_LINE_COVERED,$sum_COMPLEXITY_MISSED,$sum_COMPLEXITY_COVERED,$sum_METHOD_MISSED,$sum_METHOD_COVERED\n);
close(CSV);
my $instructions_total=$sum_INSTRUCTION_MISSED+$sum_INSTRUCTION_COVERED;
my $instruction_coverage= (100*$sum_INSTRUCTION_COVERED)/$instructions_total;

my $percent=sprintf("%.0f",${instruction_coverage});
print qq(${percent}\n);
